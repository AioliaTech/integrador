{% extends "base.html" %}

{% block title %}{% if veiculo %}Editar{% else %}Novo{% endif %} Ve√≠culo{% endblock %}

{% block content %}
<div class="bg-gray-100 min-h-screen">
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <a href="{{ url_for('dashboard') }}" class="text-orange hover:text-orange-dark mr-4">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </a>
                    <h1 class="text-xl font-bold text-gray-800">
                        {% if veiculo %}Editar Ve√≠culo{% else %}Novo Ve√≠culo{% endif %}
                    </h1>
                </div>
                <a href="{{ url_for('logout') }}" class="bg-gray-500 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sair
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <form id="veiculoForm" method="POST" enctype="multipart/form-data" class="bg-white rounded-xl shadow-lg p-8">
            {% if veiculo %}
                <input type="hidden" name="id" value="{{ veiculo.id }}">
                <input type="hidden" id="fotosExistentes" name="fotos_existentes" value="{{ veiculo.fotos|tojson if veiculo.fotos else '[]' }}">
            {% endif %}

            <!-- Informa√ß√µes B√°sicas -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-car mr-3 text-orange"></i>Informa√ß√µes B√°sicas
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Tipo -->
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            <i class="fas fa-tag mr-2 text-orange"></i>Tipo de Ve√≠culo
                        </label>
                        <select name="tipo" id="tipo" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-orange">
                            <option value="">Selecione o tipo</option>
                            <option value="carros" {% if veiculo and veiculo.tipo == 'carros' %}selected{% endif %}>üöó Carro</option>
                            <option value="motos" {% if veiculo and veiculo.tipo == 'motos' %}selected{% endif %}>üèçÔ∏è Moto</option>
                        </select>
                    </div>

                    <!-- Marca -->
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            <i class="fas fa-industry mr-2 text-orange"></i>Marca
                        </label>
                        <select name="marca_id" id="marca" required disabled
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-orange disabled:bg-gray-100">
                            <option value="">Selecione a marca</option>
                        </select>
                        <input type="hidden" name="marca_nome" id="marcaNome">
                    </div>

                    <!-- Modelo -->
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            <i class="fas fa-car-side mr-2 text-orange"></i>Modelo
                        </label>
                        <select name="modelo_id" id="modelo" required disabled
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-orange disabled:bg-gray-100">
                            <option value="">Selecione o modelo</option>
                        </select>
                        <input type="hidden" name="modelo_nome" id="modeloNome">
                    </div>

                    <!-- Vers√£o -->
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            <i class="fas fa-cog mr-2 text-orange"></i>Vers√£o
                        </label>
                        <select name="versao_id" id="versao" required disabled
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-orange disabled:bg-gray-100">
                            <option value="">Selecione a vers√£o</option>
                        </select>
                        <input type="hidden" name="versao_nome" id="versaoNome">
                    </div>
                </div>
            </div>

            <!-- Dados do Ve√≠culo -->
            <div id="dadosVeiculo" class="{% if not veiculo %}hidden{% endif %}">
                <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-info-circle mr-3 text-orange"></i>Detalhes do Ve√≠culo
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ano Modelo</label>
                        <input type="number" name="ano_modelo" id="anoModelo" required disabled
                               value="{{ veiculo.ano_modelo if veiculo else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange disabled:bg-gray-100">
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ano Fabrica√ß√£o</label>
                        <input type="number" name="ano_fabricacao" required disabled
                               value="{{ veiculo.ano_fabricacao if veiculo else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange disabled:bg-gray-100">
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">KM</label>
                        <input type="number" name="km" required disabled
                               value="{{ veiculo.km if veiculo else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange disabled:bg-gray-100">
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Cor</label>
                        <input type="text" name="cor" required disabled
                               value="{{ veiculo.cor if veiculo else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange disabled:bg-gray-100">
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Combust√≠vel</label>
                        <input type="text" name="combustivel" id="combustivel" readonly disabled
                               value="{{ veiculo.combustivel if veiculo else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">C√¢mbio</label>
                        <select name="cambio" required disabled
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange disabled:bg-gray-100">
                            <option value="">Selecione</option>
                            <option value="Manual" {% if veiculo and veiculo.cambio == 'Manual' %}selected{% endif %}>Manual</option>
                            <option value="Autom√°tico" {% if veiculo and veiculo.cambio == 'Autom√°tico' %}selected{% endif %}>Autom√°tico</option>
                            <option value="CVT" {% if veiculo and veiculo.cambio == 'CVT' %}selected{% endif %}>CVT</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Motor</label>
                        <input type="text" name="motor" id="motor" readonly disabled
                               value="{{ veiculo.motor if veiculo else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Portas</label>
                        <input type="number" name="portas" id="portas" readonly disabled
                               value="{{ veiculo.portas if veiculo else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Categoria</label>
                        <input type="text" name="categoria" required disabled
                               value="{{ veiculo.categoria if veiculo else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange disabled:bg-gray-100">
                    </div>

                    <div id="cilindradaDiv" class="{% if not veiculo or veiculo.tipo != 'motos' %}hidden{% endif %}">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Cilindrada</label>
                        <input type="text" name="cilindrada" disabled
                               value="{{ veiculo.cilindrada if veiculo else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange disabled:bg-gray-100">
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Pre√ßo (R$)</label>
                        <input type="number" step="0.01" name="preco" required disabled
                               value="{{ veiculo.preco if veiculo else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange disabled:bg-gray-100">
                    </div>
                </div>

                <!-- Upload de Fotos -->
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        <i class="fas fa-images mr-2 text-orange"></i>Fotos
                    </label>
                    <input type="file" name="fotos" multiple accept="image/*" disabled
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange disabled:bg-gray-100">
                    
                    {% if veiculo and veiculo.fotos %}
                    <div class="mt-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Fotos Atuais:</h4>
                        <div id="fotosAtuais" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            {% for foto in veiculo.fotos %}
                            <div class="relative group">
                                <img src="{{ foto }}" alt="Foto do ve√≠culo" class="w-full h-24 object-cover rounded">
                                <button type="button" onclick="removerFoto('{{ foto }}')"
                                        class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 text-xs hover:bg-red-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Bot√µes -->
                <div class="flex space-x-4">
                    <button type="submit" 
                            class="bg-orange text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-dark transition-colors">
                        <i class="fas fa-save mr-2"></i>Salvar Ve√≠culo
                    </button>
                    <a href="{{ url_for('dashboard') }}" 
                       class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </a>
                </div>
            </div>
        </form>
    </main>
</div>

{% block scripts %}
<script>
let fotosExistentes = {% if veiculo and veiculo.fotos %}{{ veiculo.fotos|tojson }}{% else %}[]{% endif %};

$(document).ready(function() {
    // Eventos de mudan√ßa nos selects
    $('#tipo').change(function() {
        const tipo = $(this).val();
        console.log('Tipo selecionado:', tipo);
        
        if (tipo) {
            carregarMarcas(tipo);
            $('#marca').prop('disabled', false);
            
            // Mostrar/ocultar campo cilindrada
            if (tipo === 'motos') {
                $('#cilindradaDiv').removeClass('hidden');
            } else {
                $('#cilindradaDiv').addClass('hidden');
            }
        } else {
            resetForm();
        }
    });

    $('#marca').change(function() {
        const marcaId = $(this).val();
        const marcaNome = $(this).find('option:selected').text();
        $('#marcaNome').val(marcaNome);
        
        if (marcaId) {
            carregarModelos($('#tipo').val(), marcaId);
            $('#modelo').prop('disabled', false);
        } else {
            resetModelos();
        }
    });

    $('#modelo').change(function() {
        const modeloId = $(this).val();
        const modeloNome = $(this).find('option:selected').text();
        $('#modeloNome').val(modeloNome);
        
        if (modeloId) {
            carregarAnos($('#tipo').val(), $('#marca').val(), modeloId);
            $('#versao').prop('disabled', false);
        } else {
            resetVersoes();
        }
    });

    $('#versao').change(function() {
        const anoId = $(this).val();
        const versaoNome = $(this).find('option:selected').text();
        $('#versaoNome').val(versaoNome);
        
        if (anoId) {
            carregarDetalhes($('#tipo').val(), $('#marca').val(), $('#modelo').val(), anoId);
            liberarCampos();
        } else {
            bloquearCampos();
        }
    });

    // Se estiver editando, carregar dados
    {% if veiculo %}
        setTimeout(function() {
            $('#tipo').trigger('change');
            setTimeout(function() {
                $('#marca').val({{ veiculo.marca_id }}).trigger('change');
                setTimeout(function() {
                    $('#modelo').val({{ veiculo.modelo_id }}).trigger('change');
                    setTimeout(function() {
                        $('#versao').val('{{ veiculo.ano_modelo }}-1');
                        liberarCampos();
                    }, 1000);
                }, 1000);
            }, 1000);
        }, 500);
    {% endif %}
});

function carregarMarcas(tipo) {
    console.log('Carregando marcas para:', tipo);
    showLoading();
    
    $.get(`/api/marcas/${tipo}`)
        .done(function(marcas) {
            console.log('Marcas recebidas:', marcas.length);
            let options = '<option value="">Selecione a marca</option>';
            marcas.forEach(function(marca) {
                options += `<option value="${marca.codigo}">${marca.nome}</option>`;
            });
            $('#marca').html(options).prop('disabled', false);
        })
        .fail(function(xhr, status, error) {
            console.error('Erro ao carregar marcas:', error);
            alert('Erro ao carregar marcas: ' + error);
        })
        .always(function() {
            hideLoading();
        });
}

function carregarModelos(tipo, marcaId) {
    showLoading();
    
    $.get(`/api/modelos/${tipo}/${marcaId}`)
        .done(function(modelos) {
            let options = '<option value="">Selecione o modelo</option>';
            modelos.forEach(function(modelo) {
                options += `<option value="${modelo.codigo}">${modelo.nome}</option>`;
            });
            $('#modelo').html(options).prop('disabled', false);
        })
        .fail(function() {
            alert('Erro ao carregar modelos');
        })
        .always(function() {
            hideLoading();
        });
}

function carregarAnos(tipo, marcaId, modeloId) {
    showLoading();
    
    $.get(`/api/anos/${tipo}/${marcaId}/${modeloId}`)
        .done(function(anos) {
            let options = '<option value="">Selecione a vers√£o</option>';
            anos.forEach(function(ano) {
                options += `<option value="${ano.codigo}">${ano.nome}</option>`;
            });
            $('#versao').html(options).prop('disabled', false);
        })
        .fail(function() {
            alert('Erro ao carregar vers√µes');
        })
        .always(function() {
            hideLoading();
        });
}

function carregarDetalhes(tipo, marcaId, modeloId, anoId) {
    showLoading();
    
    $.get(`/api/detalhes/${tipo}/${marcaId}/${modeloId}/${anoId}`)
        .done(function(detalhes) {
            $('#anoModelo').val(detalhes.AnoModelo);
            $('#combustivel').val(detalhes.Combustivel);
            $('#motor').val(detalhes.SiglaCombustivel);
            
            if (detalhes.Modelo && detalhes.Modelo.includes('Portas')) {
                const match = detalhes.Modelo.match(/(\d+)\s*Portas?/i);
                if (match) {
                    $('#portas').val(match[1]);
                }
            }
        })
        .fail(function() {
            alert('Erro ao carregar detalhes');
        })
        .always(function() {
            hideLoading();
        });
}

function liberarCampos() {
    $('#dadosVeiculo').removeClass('hidden');
    $('#dadosVeiculo input, #dadosVeiculo select').not('[readonly]').prop('disabled', false);
    $('#dadosVeiculo').hide().fadeIn(500);
}

function bloquearCampos() {
    $('#dadosVeiculo').addClass('hidden');
    $('#dadosVeiculo input, #dadosVeiculo select').prop('disabled', true);
}

function resetForm() {
    $('#marca, #modelo, #versao').prop('disabled', true).html('<option value="">Selecione</option>');
    $('#dadosVeiculo').addClass('hidden');
}

function resetModelos() {
    $('#modelo, #versao').prop('disabled', true).html('<option value="">Selecione</option>');
    $('#dadosVeiculo').addClass('hidden');
}

function resetVersoes() {
    $('#versao').prop('disabled', true).html('<option value="">Selecione</option>');
    $('#dadosVeiculo').addClass('hidden');
}

function removerFoto(fotoUrl) {
    if (confirm('Remover esta foto?')) {
        fotosExistentes = fotosExistentes.filter(foto => foto !== fotoUrl);
        $('#fotosExistentes').val(JSON.stringify(fotosExistentes));
        
        $(`img[src="${fotoUrl}"]`).closest('.group').remove();
    }
}

// Submit do formul√°rio
$('#veiculoForm').submit(function(e) {
    showLoading();
});
</script>
{% endblock %}
{% endblock %}
